{% extends "base.html" %} {% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2">üá®üá± Dashboard Financiero Chile</h1>
        {% if configured %}
        <div>
          <a href="{{ url_for('fintoc_connect') }}" class="btn btn-primary">
            <i class="fas fa-plus me-2"></i>Conectar Banco Chileno
          </a>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  {% if not configured %}
  <div class="row">
    <div class="col-12">
      <div class="alert alert-warning" role="alert">
        <h4 class="alert-heading">Fintoc Not Configured</h4>
        <p>
          To use the financial dashboard, you need to configure your Fintoc API
          credentials.
        </p>
        <p class="mb-0">
          Please set the <code>FINTOC_API_KEY</code> environment variable with
          your Fintoc API key.
        </p>
      </div>
    </div>
  </div>
  {% else %}

  <!-- Financial Summary Cards -->
  {% if financial_data %}
  <div class="row mb-4">
    {% for data in financial_data %}
    <div class="col-md-6 col-lg-4 mb-3">
      <div class="card h-100">
        <div
          class="card-header d-flex justify-content-between align-items-center"
        >
          <h5 class="card-title mb-0">
            {{ data.link.institution.name if data.link.institution else 'Bank
            Account' }}
          </h5>
          <span class="badge bg-success">Connected</span>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-12 mb-3">
              <h3 class="text-primary">
                {% if data.summary.currency == 'CLP' %} ${{
                "{:,.0f}".format(data.summary.total_balance|int) }} CLP {% elif
                data.summary.currency == 'USD' %} ${{
                "{:,.2f}".format(data.summary.total_balance / 100) }} USD {%
                else %} {{ "{:,.2f}".format(data.summary.total_balance / 100) }}
                {{ data.summary.currency }} {% endif %}
              </h3>
              <p class="text-muted mb-0">Total Balance</p>
            </div>
            <div class="col-6">
              <p class="mb-1">
                <strong>{{ data.summary.accounts_count }}</strong>
              </p>
              <p class="text-muted small mb-0">Accounts</p>
            </div>
            <div class="col-6">
              <p class="mb-1">
                <strong
                  >{{ data.link.institution.country|upper if
                  data.link.institution else 'N/A' }}</strong
                >
              </p>
              <p class="text-muted small mb-0">Country</p>
            </div>
          </div>
          <div class="mt-3">
            <button
              class="btn btn-outline-primary btn-sm"
              onclick="loadAccountDetails('{{ data.link.id }}')"
            >
              View Accounts
            </button>
            <button
              class="btn btn-outline-secondary btn-sm"
              onclick="refreshBankData('{{ data.link.id }}')"
            >
              Refresh Data
            </button>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- Accounts Detail Section -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">Bank Accounts</h5>
        </div>
        <div class="card-body">
          <div id="accounts-container">
            {% if not financial_data %}
            <div class="text-center py-5">
              <i class="fas fa-university fa-3x text-muted mb-3"></i>
              <h4>No tienes cuentas bancarias conectadas</h4>
              <p class="text-muted">
                Conecta tu cuenta bancaria chilena para comenzar a gestionar tus
                finanzas.
              </p>
              <a
                href="{{ url_for('fintoc_connect') }}"
                class="btn btn-primary btn-lg"
              >
                <i class="fas fa-plus me-2"></i>Conectar Banco Chileno
              </a>
            </div>
            {% else %}
            <p class="text-muted">
              Select a bank connection above to view account details.
            </p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Accounts Detail Section with Recent Transactions -->
  {% if financial_data %}
  {% for data in financial_data %}
  {% if data.accounts %}
  <div class="row mt-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="fas fa-credit-card me-2"></i>
            Cuentas de {{ data.link.institution.name if data.link.institution else 'Banco' }}
          </h5>
        </div>
        <div class="card-body">
          {% for account in data.accounts %}
          <div class="card mb-3">
            <div class="card-header">
              <div class="row align-items-center">
                <div class="col-md-6">
                  <h6 class="mb-0">{{ account.name }}</h6>
                  <small class="text-muted">{{ account.type }} ‚Ä¢ {{ account.number }}</small>
                </div>
                <div class="col-md-6 text-md-end">
                  <h4 class="mb-0 {% if account.balance.current >= 0 %}text-success{% else %}text-danger{% endif %}">
                    {% if account.currency == 'CLP' %}
                      ${{ "{:,.0f}".format(account.balance.current|int) }} CLP
                    {% else %}
                      {{ "{:,.2f}".format(account.balance.current / 100) }} {{ account.currency }}
                    {% endif %}
                  </h4>
                </div>
              </div>
            </div>
            {% if account.recent_movements %}
            <div class="card-body">
              <h6 class="card-subtitle mb-3 text-muted">
                <i class="fas fa-history me-2"></i>Transacciones Recientes (√∫ltimos 30 d√≠as)
              </h6>
              {% if account.recent_movements|length > 0 %}
              <div class="table-responsive">
                <table class="table table-hover table-sm">
                  <thead>
                    <tr>
                      <th>Fecha</th>
                      <th>Descripci√≥n</th>
                      <th>Tipo</th>
                      <th class="text-end">Monto</th>
                      <th class="text-center">Estado</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for movement in account.recent_movements[:10] %}
                    <tr>
                      <td>
                        <small>{{ movement.post_date }}</small>
                      </td>
                      <td>
                        <div>{{ movement.description }}</div>
                        {% if movement.comment %}
                        <small class="text-muted">{{ movement.comment }}</small>
                        {% endif %}
                      </td>
                      <td>
                        <span class="badge bg-secondary">{{ movement.type }}</span>
                      </td>
                      <td class="text-end {% if movement.amount >= 0 %}text-success{% else %}text-danger{% endif %}">
                        <strong>
                          {% if movement.currency == 'CLP' %}
                            ${{ "{:,.0f}".format(movement.amount|int) }}
                          {% else %}
                            {{ "{:,.2f}".format(movement.amount / 100) }}
                          {% endif %}
                          {{ movement.currency }}
                        </strong>
                      </td>
                      <td class="text-center">
                        {% if movement.pending %}
                          <span class="badge bg-warning">Pendiente</span>
                        {% else %}
                          <span class="badge bg-success">Completada</span>
                        {% endif %}
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              <div class="text-center mt-3">
                <button class="btn btn-outline-primary btn-sm" onclick="loadMoreTransactions('{{ account.id }}')">
                  <i class="fas fa-plus me-1"></i>Ver M√°s Transacciones
                </button>
                <button class="btn btn-outline-secondary btn-sm" onclick="refreshAccount('{{ account.id }}')">
                  <i class="fas fa-sync-alt me-1"></i>Actualizar
                </button>
              </div>
              {% else %}
              <div class="text-center py-3">
                <i class="fas fa-file-invoice text-muted fa-2x mb-2"></i>
                <p class="text-muted mb-0">No se encontraron transacciones recientes</p>
              </div>
              {% endif %}
            </div>
            {% else %}
            <div class="card-body">
              <div class="text-center py-3">
                <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                <span class="text-muted">Cargando transacciones...</span>
                <button class="btn btn-outline-primary btn-sm ms-3" onclick="loadTransactions('{{ account.id }}')">
                  <i class="fas fa-sync-alt me-1"></i>Cargar Transacciones
                </button>
              </div>
            </div>
            {% endif %}
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
  {% endif %}
  {% endfor %}
  {% endif %}

  {% endif %}
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body text-center py-4">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 mb-0">Loading financial data...</p>
      </div>
    </div>
  </div>
</div>

<script>
  // Load account details for a specific link
  function loadAccountDetails(linkId) {
    const container = document.getElementById("accounts-container");
    const modal = new bootstrap.Modal(document.getElementById("loadingModal"));

    modal.show();

    fetch(`/api/fintoc/accounts/${linkId}`)
      .then((response) => response.json())
      .then((data) => {
        modal.hide();
        if (data.status === "success") {
          displayAccounts(data.accounts);
        } else {
          container.innerHTML =
            '<div class="alert alert-danger">Error loading accounts</div>';
        }
      })
      .catch((error) => {
        modal.hide();
        console.error("Error:", error);
        container.innerHTML =
          '<div class="alert alert-danger">Error loading accounts</div>';
      });
  }

  // Display accounts in the UI
  function displayAccounts(accounts) {
    const container = document.getElementById("accounts-container");

    if (accounts.length === 0) {
      container.innerHTML = '<p class="text-muted">No accounts found.</p>';
      return;
    }

    let html = '<div class="row">';

    accounts.forEach((account) => {
      const balance = account.balance ? account.balance.current : 0;
      const currency = account.balance ? account.balance.currency : "N/A";
      const formattedBalance = formatCurrency(balance, currency);

      html += `
            <div class="col-md-6 col-lg-4 mb-3">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title">${account.name}</h6>
                        <p class="card-text">
                            <strong>${formattedBalance}</strong><br>
                            <small class="text-muted">${account.type} ‚Ä¢ ${account.number}</small>
                        </p>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="loadTransactions('${account.id}')">
                                View Transactions
                            </button>
                            <button class="btn btn-outline-secondary" onclick="refreshAccount('${account.id}')">
                                Refresh
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });

    html += "</div>";
    container.innerHTML = html;
  }

  // Load transactions for a specific account
  function loadTransactions(accountId) {
    const button = event.target;
    const originalText = button.innerHTML;
    
    button.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Cargando...';
    button.disabled = true;

    fetch(`/api/fintoc/movements/${accountId}?limit=20`)
      .then((response) => response.json())
      .then((data) => {
        button.innerHTML = originalText;
        button.disabled = false;
        
        if (data.status === "success") {
          // Update the account card with transactions
          updateAccountTransactions(accountId, data.movements);
        } else {
          showAlert('Error al cargar transacciones: ' + (data.error || 'Error desconocido'), 'danger');
        }
      })
      .catch((error) => {
        button.innerHTML = originalText;
        button.disabled = false;
        console.error("Error:", error);
        showAlert('Error de conexi√≥n al cargar transacciones', 'danger');
      });
  }

  // Load more transactions for a specific account
  function loadMoreTransactions(accountId) {
    const modal = new bootstrap.Modal(document.getElementById("loadingModal"));
    modal.show();

    fetch(`/api/fintoc/movements/${accountId}?limit=50`)
      .then((response) => response.json())
      .then((data) => {
        modal.hide();
        if (data.status === "success") {
          displayTransactionsModal(data.movements, accountId);
        } else {
          showAlert('Error al cargar m√°s transacciones', 'danger');
        }
      })
      .catch((error) => {
        modal.hide();
        console.error("Error:", error);
        showAlert('Error de conexi√≥n', 'danger');
      });
  }

  // Display transactions in the UI
  function displayTransactions(movements) {
    const container = document.getElementById("transactions-container");

    if (movements.length === 0) {
      container.innerHTML =
        '<p class="text-muted">No recent transactions found.</p>';
      return;
    }

    let html =
      '<div class="table-responsive"><table class="table table-hover">';
    html +=
      "<thead><tr><th>Date</th><th>Description</th><th>Type</th><th>Amount</th><th>Status</th></tr></thead><tbody>";

    movements.forEach((movement) => {
      const date = new Date(movement.post_date).toLocaleDateString();
      const amount = formatCurrency(movement.amount, movement.currency);
      const amountClass = movement.amount >= 0 ? "text-success" : "text-danger";
      const statusBadge = movement.pending
        ? '<span class="badge bg-warning">Pending</span>'
        : '<span class="badge bg-success">Completed</span>';

      html += `
            <tr>
                <td>${date}</td>
                <td>
                    <div>${movement.description}</div>
                    ${
                      movement.comment
                        ? '<small class="text-muted">' +
                          movement.comment +
                          "</small>"
                        : ""
                    }
                </td>
                <td><span class="badge bg-secondary">${
                  movement.type
                }</span></td>
                <td class="${amountClass}"><strong>${amount}</strong></td>
                <td>${statusBadge}</td>
            </tr>
        `;
    });

    html += "</tbody></table></div>";
    container.innerHTML = html;
  }

  // Format currency amounts
  function formatCurrency(amount, currency) {
    if (currency === "CLP") {
      return `$${Math.round(amount).toLocaleString('es-CL')} CLP`;
    } else if (currency === "USD") {
      return `$${(amount / 100).toFixed(2)} USD`;
    } else {
      return `${(amount / 100).toFixed(2)} ${currency}`;
    }
  }

  // Refresh account data
  function refreshAccount(accountId) {
    fetch(`/api/fintoc/refresh/${accountId}`, { method: "POST" })
      .then((response) => response.json())
      .then((data) => {
        if (data.status === "success") {
          // Show success message
          const alert = document.createElement("div");
          alert.className = "alert alert-success alert-dismissible fade show";
          alert.innerHTML = `
                    ${data.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
          document.querySelector(".container-fluid").prepend(alert);

          // Auto-hide after 3 seconds
          setTimeout(() => alert.remove(), 3000);
        } else {
          alert("Error refreshing account data");
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        alert("Error refreshing account data");
      });
  }

  // Refresh bank data for a link
  function refreshBankData(linkId) {
    // This would trigger refresh for all accounts in the link
    showAlert('Actualizaci√≥n iniciada. Los datos se actualizar√°n en breve.', 'info');
  }

  // Update account transactions in the existing card
  function updateAccountTransactions(accountId, movements) {
    // This would update the specific account card with new transactions
    // For now, show success message
    showAlert('Transacciones cargadas exitosamente', 'success');
  }

  // Display transactions in a modal
  function displayTransactionsModal(movements, accountId) {
    // Create and show a modal with all transactions
    const modalHtml = `
      <div class="modal fade" id="transactionsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Todas las Transacciones</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              ${generateTransactionsTable(movements)}
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
          </div>
        </div>
      </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('transactionsModal');
    if (existingModal) {
      existingModal.remove();
    }
    
    // Add modal to body
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('transactionsModal'));
    modal.show();
  }

  // Generate transactions table HTML
  function generateTransactionsTable(movements) {
    if (movements.length === 0) {
      return '<p class="text-muted text-center">No se encontraron transacciones.</p>';
    }

    let html = '<div class="table-responsive"><table class="table table-hover">';
    html += '<thead><tr><th>Fecha</th><th>Descripci√≥n</th><th>Tipo</th><th class="text-end">Monto</th><th class="text-center">Estado</th></tr></thead><tbody>';

    movements.forEach((movement) => {
      const date = new Date(movement.post_date).toLocaleDateString('es-CL');
      const amountClass = movement.amount >= 0 ? "text-success" : "text-danger";
      const statusBadge = movement.pending
        ? '<span class="badge bg-warning">Pendiente</span>'
        : '<span class="badge bg-success">Completada</span>';

      let formattedAmount;
      if (movement.currency === 'CLP') {
        formattedAmount = `$${Math.round(movement.amount).toLocaleString('es-CL')} CLP`;
      } else {
        formattedAmount = `${(movement.amount / 100).toFixed(2)} ${movement.currency}`;
      }

      html += `
        <tr>
          <td><small>${date}</small></td>
          <td>
            <div>${movement.description}</div>
            ${movement.comment ? '<small class="text-muted">' + movement.comment + '</small>' : ''}
          </td>
          <td><span class="badge bg-secondary">${movement.type}</span></td>
          <td class="text-end ${amountClass}"><strong>${formattedAmount}</strong></td>
          <td class="text-center">${statusBadge}</td>
        </tr>
      `;
    });

    html += '</tbody></table></div>';
    return html;
  }

  // Show alert message
  function showAlert(message, type = 'info') {
    const alert = document.createElement("div");
    alert.className = `alert alert-${type} alert-dismissible fade show`;
    alert.innerHTML = `
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.querySelector(".container-fluid").prepend(alert);

    // Auto-hide after 5 seconds
    setTimeout(() => {
      if (alert && alert.parentNode) {
        alert.remove();
      }
    }, 5000);
  }
</script>
{% endblock %}
